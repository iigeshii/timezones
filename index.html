<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crimson Cuckoo Coven Member Time Zone Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- Shared CSS -->
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <h1>Crimson Cuckoo Coven Member Time Zone Board</h1>
  <div class="subtitle">
    Quick reference for everyone’s current time, plus an event options planner below.
  </div>

  <!-- Local time + quick reference -->
  <div class="card">
    <div class="control-group">
      <label>
        Now (your local):
        <span id="localTzLabel" class="highlight"></span>
      </label>
      <div id="localNow" class="highlight"></div>
      <div id="localTzPrint" class="small-note"></div>

      <div class="chip">
        <span class="chip-dot"></span>
        <span>Auto-updates</span>
      </div>

      <div class="small-note" style="margin-top:0.75rem;">
        Scroll down to the Event Planner to compare up to four UTC-based options for everyone.
      </div>
    </div>
  </div>

  <!-- Current time table -->
  <div class="card table-card">
    <div class="card-title">Current Time Board</div>
    <div class="small-note">Live view of what time it is for everyone right now.</div>
    <table>
      <thead>
        <tr>
          <th>Member</th>
          <th>Current Time</th>
        </tr>
      </thead>
      <tbody id="currentBody"></tbody>
    </table>
  </div>

  <!-- Toggle Button -->
  <div class="card">
    <button id="toggleEventPlanner" class="toggle-btn">Show Event Planner</button>
  </div>

  <!-- Event planner wrapper (initially hidden) -->
  <div id="eventPlannerWrapper" style="display: none;">

    <!-- Event planner controls -->
    <div class="card">
      <div class="control-group">
        <label>Event Time Board Title</label>
        <input
          id="eventBoardTitle"
          type="text"
          placeholder="Event Time Board (click to rename)"
          style="margin-bottom: 0.75rem; width: 100%; padding: 6px;"
        />

        <label>Event options (times in UTC)</label>
        <div class="small-note">
          Set up to four UTC event times. The Event Time Board converts them to each member’s local time.
        </div>

        <div class="small-note" style="margin-top:0.5rem;">Option 1 (UTC)</div>
        <input id="eventTime1" type="text" placeholder="YYYY-MM-DD HH:MM" />

        <div class="small-note" style="margin-top:0.7rem;">Option 2 (UTC)</div>
        <input id="eventTime2" type="text" placeholder="YYYY-MM-DD HH:MM" />

        <div class="small-note" style="margin-top:0.7rem;">Option 3 (UTC)</div>
        <input id="eventTime3" type="text" placeholder="YYYY-MM-DD HH:MM" />

        <div class="small-note" style="margin-top:0.7rem;">Option 4 (UTC)</div>
        <input id="eventTime4" type="text" placeholder="YYYY-MM-DD HH:MM" />

        <div class="small-note" style="margin-top:0.7rem;">
          All event times above are treated as UTC. The board below shows each member’s local time.
        </div>
      </div>
    </div>

    <!-- Event time table -->
    <div class="card table-card">
      <div class="card-title" id="eventBoardTitleDisplay">Event Time Board</div>
      <table>
        <thead>
          <tr>
            <th>Member</th>
            <th id="optionHeader1">Option 1</th>
            <th id="optionHeader2">Option 2</th>
            <th id="optionHeader3">Option 3</th>
            <th id="optionHeader4">Option 4</th>
          </tr>
        </thead>
        <tbody id="eventBody"></tbody>
      </table>
    </div>

  </div>

  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Main Script -->
  <script>
    const members = [
      { name: "Universal (UTC)",                    timeZone: "UTC" },
      { name: "GeshGiezel",                         timeZone: "America/Phoenix" },
      { name: "The Auld Witch / Poppie",            timeZone: "Europe/London" },
      { name: "Fredo / Bomberbird248",              timeZone: "Europe/Berlin" },
      { name: "Skullman",                           timeZone: "Europe/London" },
      { name: "Kaiusz / KVG89",                     timeZone: "Europe/Amsterdam" },
      //{ name: "The Primeval Queen / vampireXgoth",  timeZone: "America/Chicago" },
      { name: "Cloud / DiabolicalCloud",            timeZone: "America/Regina" },
      { name: "Emsi1y2255",                         timeZone: "America/Chicago" },
      { name: "Kitty / porcelaingamer8",            timeZone: "America/New_York" },
      { name: "CALIFER / CALIFER25",                timeZone: "Asia/Singapore" },
      { name: "Hitesh / Hitesh2550",                timeZone: "Asia/Kolkata" },
      { name: "Tala / Aikois",                      timeZone: "Asia/Manila" },
      { name: "Flameboi789 / Flame7484",            timeZone: "America/Los_Angeles" },
      { name: "zet / SvelteAtom2577",               timeZone: "Europe/Berlin" },   // GMT+1
      { name: "Suwa / Suwa7506",                    timeZone: "Asia/Kolkata" },    // GMT+5:30
      { name: "Lil Roony / Lil Roony woo",          timeZone: "Asia/Kolkata" },    // GMT+5:30
      { name: "LadyVonDawn",                        timeZone: "Asia/Manila" },     // GMT+8 (Philippines)
    ];

    const EVENT_OPTION_COUNT = 4;
    const eventOptions = Array.from({ length: EVENT_OPTION_COUNT }, () => ({ utcDate: null }));

    const currentBody = document.getElementById("currentBody");
    const eventBody = document.getElementById("eventBody");
    const localNowEl = document.getElementById("localNow");
    const localTzPrint = document.getElementById("localTzPrint");
    const localTzLabel = document.getElementById("localTzLabel");

    const eventBoardTitleInput = document.getElementById("eventBoardTitle");
    const eventBoardTitleDisplay = document.getElementById("eventBoardTitleDisplay");

    const localTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    localTzLabel.textContent = localTimeZone;
    localTzPrint.textContent = `(${localTimeZone})`;

    eventBoardTitleInput.addEventListener("input", () => {
      const text = eventBoardTitleInput.value.trim();
      eventBoardTitleDisplay.textContent = text || "Event Time Board";
      updateURLParams();
    });

    function dualFormat(date, timeZone) {
      if (!date) return "—";

      const f24 = new Intl.DateTimeFormat("en-US", {
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false, weekday: "short", month: "short", day: "2-digit", timeZone,
      }).format(date);

      const f12 = new Intl.DateTimeFormat("en-US", {
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: true, timeZone,
      }).format(date);

      return `${f24}<br><span class="twelve-hour">${f12}</span>`;
    }

    function getZoneLabel(timeZone) {
      const now = new Date();
      const partsShort = new Intl.DateTimeFormat("en-US", {
        timeZone, hour: "2-digit", minute: "2-digit", timeZoneName: "short",
      }).formatToParts(now);

      const partsOffset = new Intl.DateTimeFormat("en-US", {
        timeZone, hour: "2-digit", minute: "2-digit", timeZoneName: "shortOffset",
      }).formatToParts(now);

      let abbr = partsShort.find(p => p.type === "timeZoneName")?.value || "";
      let offset = partsOffset.find(p => p.type === "timeZoneName")?.value || "";

      offset = offset.replace("UTC", "GMT");

      const preferredAbbr = {
        "Europe/Berlin": "CET", "Europe/Amsterdam": "CET", "Europe/London": "GMT",
        "Asia/Singapore": "SGT", "America/Phoenix": "MST", "America/Chicago": "CST",
        "America/New_York": "EST", "America/Regina": "CST", "Asia/Kolkata": "IST",
        "Asia/Manila": "PHT", "America/Los_Angeles": "PST", "UTC": "UTC",
      };

      if ((abbr === offset || abbr === "") && preferredAbbr[timeZone]) {
        abbr = preferredAbbr[timeZone];
      }

      return (abbr === offset || abbr === "") ? `(${offset})` : `(${abbr} / ${offset})`;
    }

    function getZonedTimestamp(date, timeZone) {
      const zoned = new Date(date.toLocaleString("en-US", { timeZone }));
      return zoned.getTime();
    }

    function sortMembersByLocalTime(date) {
      return [...members].sort((a, b) => getZonedTimestamp(date, b.timeZone) - getZonedTimestamp(date, a.timeZone));
    }

    function localSelectionToUTC(date) {
      if (!date) return null;
      return new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate(), date.getHours(), date.getMinutes()));
    }

    function renderCurrent() {
      const now = new Date();
      localNowEl.innerHTML = dualFormat(now, localTimeZone);
      const sorted = sortMembersByLocalTime(now);
      currentBody.innerHTML = "";

      sorted.forEach(m => {
        const label = getZoneLabel(m.timeZone);
        currentBody.innerHTML += `
          <tr class="${m.timeZone === 'UTC' ? 'utc-row' : ''}">
            <td class="name-cell">
              ${m.name}
              <div class="tz-cell">${m.timeZone} ${label}</div>
            </td>
            <td>${dualFormat(now, m.timeZone)}</td>
          </tr>`;
      });
    }

    function renderEventBoard() {
      eventBody.innerHTML = "";
      const optionStats = Array.from({ length: EVENT_OPTION_COUNT }, () => ({ good: 0, okay: 0, bad: 0 }));
      const now = new Date();
      const sortedMembers = sortMembersByLocalTime(now);

      sortedMembers.forEach(m => {
        const label = getZoneLabel(m.timeZone);
        let row = `
          <tr class="${m.timeZone === 'UTC' ? 'utc-row' : ''}">
            <td class="name-cell">
              ${m.name}
              <div class="tz-cell">${m.timeZone} ${label}</div>
            </td>`;

        for (let i = 0; i < EVENT_OPTION_COUNT; i++) {
          const opt = eventOptions[i];
          let cellContent = "Pick a date/time";
          let cellClass = "";

          if (opt.utcDate) {
            const hour = getLocalHourForUtcDate(opt.utcDate, m.timeZone);
            const slotClass = getSlotClassForHour(hour);
            cellClass = slotClass;

            if (slotClass === "slot-good") optionStats[i].good++;
            else if (slotClass === "slot-okay") optionStats[i].okay++;
            else if (slotClass === "slot-bad") optionStats[i].bad++;

            cellContent = dualFormat(opt.utcDate, m.timeZone);
          }

          row += `<td class="${cellClass}">${cellContent}</td>`;
        }

        row += `</tr>`;
        eventBody.innerHTML += row;
      });

      for (let i = 0; i < EVENT_OPTION_COUNT; i++) {
        const headerEl = document.getElementById(`optionHeader${i + 1}`);
        const opt = eventOptions[i];
        let label = `Option ${i + 1}`;
        if (opt.utcDate) {
          const utcDisplay = dualFormat(opt.utcDate, "UTC");
          const stats = optionStats[i];
          label += `
            <br><span class="twelve-hour">UTC: ${utcDisplay}</span>
            <br><span class="option-stats">
              G: ${stats.good} · O: ${stats.okay} · R: ${stats.bad}
            </span>`;
        }
        headerEl.innerHTML = label;
      }
    }

    function setupEventInputs() {
      for (let i = 0; i < EVENT_OPTION_COUNT; i++) {
        const timeInput = document.getElementById(`eventTime${i + 1}`);

        flatpickr(timeInput, {
          enableTime: true,
          time_24hr: true,
          dateFormat: "Y-m-d H:i",
          onChange: (selectedDates) => {
            const localDate = selectedDates[0] || null;
            eventOptions[i].utcDate = localSelectionToUTC(localDate);
            renderEventBoard();
            updateURLParams();
          }
        });
      }
    }

    function getLocalHourForUtcDate(utcDate, timeZone) {
      const zoned = new Date(utcDate.toLocaleString("en-US", { timeZone }));
      return zoned.getHours();
    }

    function classifyHour(hour) {
      if (hour >= 9 && hour < 22) return "good";
      if ((hour >= 7 && hour < 9) || (hour >= 22 && hour < 24)) return "okay";
      return "bad";
    }

    function getSlotClassForHour(hour) {
      const cls = classifyHour(hour);
      if (cls === "good") return "slot-good";
      if (cls === "okay") return "slot-okay";
      return "slot-bad";
    }

    function formatDateForInput(date) {
      const yyyy = date.getUTCFullYear();
      const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
      const dd = String(date.getUTCDate()).padStart(2, '0');
      const hh = String(date.getUTCHours()).padStart(2, '0');
      const mi = String(date.getUTCMinutes()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function updateURLParams() {
      const params = new URLSearchParams();
      const title = eventBoardTitleInput.value.trim();
      if (title) params.set("title", title);

      for (let i = 0; i < EVENT_OPTION_COUNT; i++) {
        const utcDate = eventOptions[i].utcDate;
        if (utcDate) {
          params.set(`time${i + 1}`, utcDate.toISOString());
        }
      }

      const newUrl = `${window.location.pathname}?${params.toString()}`;
      history.replaceState({}, "", newUrl);
    }

    function loadFromURLParams() {
      const params = new URLSearchParams(window.location.search);
      const title = params.get("title");
      if (title) {
        eventBoardTitleInput.value = title;
        eventBoardTitleDisplay.textContent = title;
      }

      for (let i = 0; i < EVENT_OPTION_COUNT; i++) {
        const isoStr = params.get(`time${i + 1}`);
        if (isoStr) {
          const utcDate = new Date(isoStr);
          if (!isNaN(utcDate)) {
            eventOptions[i].utcDate = utcDate;
            document.getElementById(`eventTime${i + 1}`).value = formatDateForInput(utcDate);
          }
        }
      }

      renderEventBoard();

      // Auto-show planner if values exist
      if (title || params.get("time1")) {
        document.getElementById("eventPlannerWrapper").style.display = "block";
        document.getElementById("toggleEventPlanner").textContent = "Hide Event Planner";
      }
    }

    document.getElementById("toggleEventPlanner").addEventListener("click", () => {
      const wrapper = document.getElementById("eventPlannerWrapper");
      const isHidden = wrapper.style.display === "none";
      wrapper.style.display = isHidden ? "block" : "none";
      document.getElementById("toggleEventPlanner").textContent = isHidden ? "Hide Event Planner" : "Show Event Planner";
    });

    setupEventInputs();
    renderCurrent();
    renderEventBoard();
    loadFromURLParams();

    setInterval(renderCurrent, 1000);
  </script>
</body>
</html>
