<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crimson Cuckoo Coven Member Time Zone Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- Your CSS -->
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <h1>Crimson Cuckoo Coven Member Time Zone Board</h1>
  <div class="subtitle">
    See everyone’s current time, plus a clean event-time table for Discord.
  </div>

  <!-- Picker / Controls -->
  <div class="card">
    <div class="controls">
      <div class="control-group">
        <label>
          Event date & time
          <span class="small-note">
            (in <span id="localTzLabel" class="highlight"></span>)
          </span>
        </label>

        <!-- Flatpickr input -->
        <input id="eventDateTime" type="text" placeholder="Pick date & time" />

        <div class="quick-buttons">
          <button type="button" class="quick-button" data-preset="tonight">
            Tonight 8:00 PM
          </button>
          <button type="button" class="quick-button" data-preset="tomorrow-evening">
            Tomorrow 7:00 PM
          </button>
          <button type="button" class="quick-button" data-preset="next-sat-afternoon">
            Next Saturday 2:00 PM
          </button>
        </div>

        <div class="small-note">
          Click the field to open a calendar + clock picker, or use a preset.
        </div>
      </div>

      <div class="control-group">
        <label>Now (your local):</label>
        <div id="localNow" class="highlight"></div>
        <div id="localTzPrint" class="small-note"></div>

        <div class="chip">
          <span class="chip-dot"></span>
          <span>Auto-updates</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tables row: Current + Event side by side -->
  <div class="table-row">
    <!-- Current time table -->
    <div class="card table-card">
      <div class="card-title">Current Time Board</div>
      <div class="small-note">Live view of what time it is for everyone right now.</div>
      <table>
        <thead>
          <tr>
            <th>Member</th>
            <th>Current Time</th>
          </tr>
        </thead>
        <tbody id="currentBody"></tbody>
      </table>
    </div>

    <!-- Event time table -->
    <div class="card table-card">
      <div class="card-title">Event Time Board</div>
      <div class="small-note">Screenshot this table after choosing an event time.</div>
      <table>
        <thead>
          <tr>
            <th>Member</th>
            <th>Event Time</th>
          </tr>
        </thead>
        <tbody id="eventBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    // ===== Members & time zones =====
    const members = [
      { name: "Universal (UTC)", timeZone: "UTC" },              // Reference row

      { name: "GeshGiezel",      timeZone: "America/Phoenix" },
      { name: "The Auld Witch / Poppie",          timeZone: "Europe/London" },
      { name: "Fredo / Bomberbird248",   timeZone: "Europe/Berlin" },
      { name: "Skullman",        timeZone: "Europe/London" },
      { name: "Kaiusz / KVG89",           timeZone: "Europe/Amsterdam" },
      { name: "The Primeval Queen / vampireXgoth",    timeZone: "America/Chicago" },
      { name: "Cloud / DiabolicalCloud", timeZone: "America/Regina" },
      { name: "Emsi1y2255",      timeZone: "America/Chicago" },
      { name: "Kitty / porcelaingamer8", timeZone: "America/New_York" },
      { name: "CALIFER25",       timeZone: "Asia/Singapore" },
      { name: "Hitesh2550",      timeZone: "Asia/Kolkata" },
      { name: "Tala / Aikois",                       timeZone: "Asia/Manila" },
      { name: "Flameboi789 / Flame7484",             timeZone: "America/Los_Angeles" },
    ];

    const currentBody    = document.getElementById("currentBody");
    const eventBody      = document.getElementById("eventBody");
    const localNowEl     = document.getElementById("localNow");
    const localTzLabel   = document.getElementById("localTzLabel");
    const localTzPrint   = document.getElementById("localTzPrint");
    const eventDateTime  = document.getElementById("eventDateTime");
    const quickButtons   = document.querySelectorAll(".quick-button");

    const localTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    localTzLabel.textContent = localTimeZone;
    localTzPrint.textContent = `(${localTimeZone})`;

    // Format a date in a target zone (with seconds)
    function formatInZone(date, timeZone) {
      if (!date) return "—";
      return new Intl.DateTimeFormat("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        weekday: "short",
        month: "short",
        day: "2-digit",
        timeZone,
      }).format(date);
    }

    // Format local "now" display
    function formatLocal(date) {
      return new Intl.DateTimeFormat("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        weekday: "short",
        month: "short",
        day: "2-digit",
      }).format(date);
    }

    // Timezone label formatter:
    // "(MST / GMT-7)", "(IST / GMT+05:30)", "(GMT+8)" if abbrev == offset
    function getZoneLabel(timeZone) {
      const now = new Date();

      const partsShort = new Intl.DateTimeFormat("en-US", {
        timeZone,
        hour: "2-digit",
        minute: "2-digit",
        timeZoneName: "short",
      }).formatToParts(now);

      const partsOffset = new Intl.DateTimeFormat("en-US", {
        timeZone,
        hour: "2-digit",
        minute: "2-digit",
        timeZoneName: "shortOffset",
      }).formatToParts(now);

      let abbr = partsShort.find(p => p.type === "timeZoneName")?.value || "";
      let offset = partsOffset.find(p => p.type === "timeZoneName")?.value || "";

      offset = offset.replace("UTC", "GMT");

      const preferredAbbr = {
        "Europe/Berlin":      "CET",
        "Europe/Amsterdam":   "CET",
        "Europe/London":      "GMT",  // will still show BST if browser decides
        "Asia/Singapore":     "SGT",
        "America/Phoenix":    "MST",
        "America/Chicago":    "CST",
        "America/New_York":   "EST",
        "America/Regina":     "CST",
        "Asia/Kolkata":       "IST",
        "UTC":                "UTC",
      };

      if ((abbr === offset || abbr === "") && preferredAbbr[timeZone]) {
        abbr = preferredAbbr[timeZone];
      }

      if (abbr === offset || abbr === "") {
        return `(${offset})`;
      }

      return `(${abbr} / ${offset})`;
    }

    // Convert a date into a numeric sortable timestamp in a given zone
    function getZonedTimestamp(date, timeZone) {
      const zoned = new Date(date.toLocaleString("en-US", { timeZone }));
      return zoned.getTime();
    }

    // Sort members by their local time at a given date (descending)
    function sortMembersByLocalTime(date) {
      return [...members].sort((a, b) => {
        const ta = getZonedTimestamp(date, a.timeZone);
        const tb = getZonedTimestamp(date, b.timeZone);
        return tb - ta; // newest (largest) first
      });
    }

    // ===== Render Current Time table + "Now (your local)" =====
    function renderCurrent() {
      const now = new Date();
      localNowEl.textContent = formatLocal(now);

      const sorted = sortMembersByLocalTime(now);
      currentBody.innerHTML = "";

      sorted.forEach(m => {
        const label = getZoneLabel(m.timeZone);

        currentBody.innerHTML += `
          <tr class="${m.timeZone === 'UTC' ? 'utc-row' : ''}">
            <td class="name-cell">
              ${m.name}
              <div class="tz-cell">${m.timeZone} ${label}</div>
            </td>
            <td>${formatInZone(now, m.timeZone)}</td>
          </tr>
        `;
      });
    }

    // ===== Render Event Time table =====
    function renderEvent(eventDate) {
      eventBody.innerHTML = "";

      if (!eventDate) {
        members.forEach(m => {
          const label = getZoneLabel(m.timeZone);
          eventBody.innerHTML += `
            <tr class="${m.timeZone === 'UTC' ? 'utc-row' : ''}">
              <td class="name-cell">
                ${m.name}
                <div class="tz-cell">${m.timeZone} ${label}</div>
              </td>
              <td>Pick a date/time</td>
            </tr>
          `;
        });
        return;
      }

      const sorted = sortMembersByLocalTime(eventDate);

      sorted.forEach(m => {
        const label = getZoneLabel(m.timeZone);
        eventBody.innerHTML += `
          <tr class="${m.timeZone === 'UTC' ? 'utc-row' : ''}">
            <td class="name-cell">
              ${m.name}
              <div class="tz-cell">${m.timeZone} ${label}</div>
            </td>
            <td>${formatInZone(eventDate, m.timeZone)}</td>
          </tr>
        `;
      });
    }

    // ===== Flatpickr date+time picker =====
    const fp = flatpickr(eventDateTime, {
      enableTime: true,
      time_24hr: false,
      dateFormat: "Y-m-d H:i",
      defaultDate: new Date(Date.now() + 24 * 60 * 60 * 1000), // +1 day
      onChange: (selectedDates) => {
        const dt = selectedDates[0] || null;
        renderEvent(dt);
      }
    });

    // ===== Preset buttons =====
    function applyPreset(preset) {
      const now = new Date();
      let t = new Date(now);

      if (preset === "tonight") {
        t.setHours(20, 0, 0, 0);
        if (t < now) t.setDate(t.getDate() + 1);
      } else if (preset === "tomorrow-evening") {
        t.setDate(t.getDate() + 1);
        t.setHours(19, 0, 0, 0);
      } else if (preset === "next-sat-afternoon") {
        const day = t.getDay(); // 0 = Sun
        const daysUntilSat = (6 - day + 7) % 7 || 7;
        t.setDate(t.getDate() + daysUntilSat);
        t.setHours(14, 0, 0, 0);
      }

      fp.setDate(t, true); // triggers onChange => renderEvent
    }

    quickButtons.forEach(btn =>
      btn.addEventListener("click", () => applyPreset(btn.dataset.preset))
    );

    // ===== Initial render =====
    const initialEvent = fp.selectedDates[0] || null;
    renderCurrent();
    renderEvent(initialEvent);

    // Live auto-update for current time table (every second)
    setInterval(renderCurrent, 1000);
  </script>
</body>
</html>
