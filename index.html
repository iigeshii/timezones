<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crimson Cuckoo Coven Member Time Zone Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- Your CSS -->
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <h1>Crimson Cuckoo Coven Member Time Zone Board</h1>
  <div class="subtitle">
    See everyone’s current time, plus multiple UTC-based event options in one board.
  </div>

  <!-- Picker / Controls -->
  <div class="card">
    <div class="controls">
      <!-- Left side: Event options + title -->
      <div class="control-group">
        <label>Event Time Board Title</label>
        <input
          id="eventBoardTitle"
          type="text"
          placeholder="Event Time Board (click to rename)"
          style="margin-bottom: 0.75rem; width: 100%; padding: 6px;"
        />

        <label>Event options (times in UTC)</label>
        <div class="small-note">
          Set up to four UTC event times. The board converts them to each member’s local time.
        </div>

        <!-- Option 1 -->
        <div class="small-note" style="margin-top:0.5rem;">Option 1 (UTC)</div>
        <input id="eventTime1" type="text" placeholder="YYYY-MM-DD HH:MM" />

        <!-- Option 2 -->
        <div class="small-note" style="margin-top:0.7rem;">Option 2 (UTC)</div>
        <input id="eventTime2" type="text" placeholder="YYYY-MM-DD HH:MM" />

        <!-- Option 3 -->
        <div class="small-note" style="margin-top:0.7rem;">Option 3 (UTC)</div>
        <input id="eventTime3" type="text" placeholder="YYYY-MM-DD HH:MM" />

        <!-- Option 4 -->
        <div class="small-note" style="margin-top:0.7rem;">Option 4 (UTC)</div>
        <input id="eventTime4" type="text" placeholder="YYYY-MM-DD HH:MM" />

        <div class="small-note" style="margin-top:0.7rem;">
          All event times above are treated as UTC. The board shows each member’s local time.
        </div>
      </div>

      <!-- Right side: Local time -->
      <div class="control-group">
        <label>
          Now (your local):
          <span id="localTzLabel" class="highlight"></span>
        </label>
        <div id="localNow" class="highlight"></div>
        <div id="localTzPrint" class="small-note"></div>

        <div class="chip">
          <span class="chip-dot"></span>
          <span>Auto-updates</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tables row: Current + Event side by side -->
  <div class="table-row">
    <!-- Current time table -->
    <div class="card table-card">
      <div class="card-title">Current Time Board</div>
      <div class="small-note">Live view of what time it is for everyone right now.</div>
      <table>
        <thead>
          <tr>
            <th>Member</th>
            <th>Current Time</th>
          </tr>
        </thead>
        <tbody id="currentBody"></tbody>
      </table>
    </div>

    <!-- Event time table -->
    <div class="card table-card">
      <div class="card-title" id="eventBoardTitleDisplay">Event Time Board</div>
      <div class="small-note">
        Shows all four event options at once. Column headers show UTC event times.
      </div>
      <table>
        <thead>
          <tr>
            <th>Member</th>
            <th id="optionHeader1">Option 1</th>
            <th id="optionHeader2">Option 2</th>
            <th id="optionHeader3">Option 3</th>
            <th id="optionHeader4">Option 4</th>
          </tr>
        </thead>
        <tbody id="eventBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    // ===== Members & time zones =====
    const members = [
      { name: "Universal (UTC)",                    timeZone: "UTC" },

      { name: "GeshGiezel",                         timeZone: "America/Phoenix" },
      { name: "The Auld Witch / Poppie",            timeZone: "Europe/London" },
      { name: "Fredo / Bomberbird248",              timeZone: "Europe/Berlin" },
      { name: "Skullman",                           timeZone: "Europe/London" },
      { name: "Kaiusz / KVG89",                     timeZone: "Europe/Amsterdam" },
      { name: "The Primeval Queen / vampireXgoth",  timeZone: "America/Chicago" },
      { name: "Cloud / DiabolicalCloud",            timeZone: "America/Regina" },
      { name: "Emsi1y2255",                         timeZone: "America/Chicago" },
      { name: "Kitty / porcelaingamer8",            timeZone: "America/New_York" },
      { name: "CALIFER / CALIFER25",                timeZone: "Asia/Singapore" },
      { name: "Hitesh / Hitesh2550",                timeZone: "Asia/Kolkata" },
      { name: "Tala / Aikois",                      timeZone: "Asia/Manila" },
      { name: "Flameboi789 / Flame7484",            timeZone: "America/Los_Angeles" },
    ];

    const EVENT_OPTION_COUNT = 4;
    const eventOptions = [
      { utcDate: null },
      { utcDate: null },
      { utcDate: null },
      { utcDate: null },
    ];

    const currentBody    = document.getElementById("currentBody");
    const eventBody      = document.getElementById("eventBody");
    const localNowEl     = document.getElementById("localNow");
    const localTzPrint   = document.getElementById("localTzPrint");
    const localTzLabel   = document.getElementById("localTzLabel");

    const eventBoardTitleInput   = document.getElementById("eventBoardTitle");
    const eventBoardTitleDisplay = document.getElementById("eventBoardTitleDisplay");

    const localTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    localTzLabel.textContent = localTimeZone;
    localTzPrint.textContent = `(${localTimeZone})`;

    // Update Event Time Board title live
    eventBoardTitleInput.addEventListener("input", () => {
      const text = eventBoardTitleInput.value.trim();
      eventBoardTitleDisplay.textContent = text || "Event Time Board";
    });

    // ===== Time formatting helpers =====

    // Dual-format on two lines:
    // "Fri, Nov 29, 17:09:46<br><span class='twelve-hour'>5:09:46 PM</span>"
    function dualFormat(date, timeZone) {
      if (!date) return "—";

      const f24 = new Intl.DateTimeFormat("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false,
        weekday: "short",
        month: "short",
        day: "2-digit",
        timeZone,
      }).format(date);

      const f12 = new Intl.DateTimeFormat("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: true,
        timeZone,
      }).format(date);

      return `${f24}<br><span class="twelve-hour">${f12}</span>`;
    }

    // Timezone label formatter, e.g. "(MST / GMT-7)" or "(GMT+8)"
    function getZoneLabel(timeZone) {
      const now = new Date();

      const partsShort = new Intl.DateTimeFormat("en-US", {
        timeZone,
        hour: "2-digit",
        minute: "2-digit",
        timeZoneName: "short",
      }).formatToParts(now);

      const partsOffset = new Intl.DateTimeFormat("en-US", {
        timeZone,
        hour: "2-digit",
        minute: "2-digit",
        timeZoneName: "shortOffset",
      }).formatToParts(now);

      let abbr = partsShort.find(p => p.type === "timeZoneName")?.value || "";
      let offset = partsOffset.find(p => p.type === "timeZoneName")?.value || "";

      offset = offset.replace("UTC", "GMT");

      const preferredAbbr = {
        "Europe/Berlin":       "CET",
        "Europe/Amsterdam":    "CET",
        "Europe/London":       "GMT",
        "Asia/Singapore":      "SGT",
        "America/Phoenix":     "MST",
        "America/Chicago":     "CST",
        "America/New_York":    "EST",
        "America/Regina":      "CST",
        "Asia/Kolkata":        "IST",
        "Asia/Manila":         "PHT",
        "America/Los_Angeles": "PST",
        "UTC":                 "UTC",
      };

      if ((abbr === offset || abbr === "") && preferredAbbr[timeZone]) {
        abbr = preferredAbbr[timeZone];
      }

      if (abbr === offset || abbr === "") {
        return `(${offset})`;
      }

      return `(${abbr} / ${offset})`;
    }

    // Convert a date into a numeric sortable timestamp in a given zone
    function getZonedTimestamp(date, timeZone) {
      const zoned = new Date(date.toLocaleString("en-US", { timeZone }));
      return zoned.getTime();
    }

    function sortMembersByLocalTime(date) {
      return [...members].sort((a, b) => {
        const ta = getZonedTimestamp(date, a.timeZone);
        const tb = getZonedTimestamp(date, b.timeZone);
        return tb - ta; // newest first
      });
    }

    // Interpret local-picked date/time as UTC clock time
    function localSelectionToUTC(date) {
      if (!date) return null;
      return new Date(Date.UTC(
        date.getFullYear(),
        date.getMonth(),
        date.getDate(),
        date.getHours(),
        date.getMinutes(),
        date.getSeconds(),
        date.getMilliseconds()
      ));
    }

    // ===== Render Current Time table + "Now (your local)" =====
    function renderCurrent() {
      const now = new Date();
      localNowEl.innerHTML = dualFormat(now, localTimeZone);

      const sorted = sortMembersByLocalTime(now);
      currentBody.innerHTML = "";

      sorted.forEach(m => {
        const label = getZoneLabel(m.timeZone);

        currentBody.innerHTML += `
          <tr class="${m.timeZone === 'UTC' ? 'utc-row' : ''}">
            <td class="name-cell">
              ${m.name}
              <div class="tz-cell">${m.timeZone} ${label}</div>
            </td>
            <td>${dualFormat(now, m.timeZone)}</td>
          </tr>
        `;
      });
    }

    // ===== Render Event Time board with 4 options =====
    function renderEventBoard() {
      // Update header labels with UTC time for each option
      for (let i = 0; i < EVENT_OPTION_COUNT; i++) {
        const headerEl = document.getElementById(`optionHeader${i + 1}`);
        const opt = eventOptions[i];

        let label = `Option ${i + 1}`;
        if (opt.utcDate) {
          const utcDisplay = dualFormat(opt.utcDate, "UTC");
          label += `<br><span class="twelve-hour">UTC: ${utcDisplay}</span>`;
        }

        headerEl.innerHTML = label;
      }

      eventBody.innerHTML = "";

      members.forEach(m => {
        const label = getZoneLabel(m.timeZone);

        let row = `
          <tr class="${m.timeZone === 'UTC' ? 'utc-row' : ''}">
            <td class="name-cell">
              ${m.name}
              <div class="tz-cell">${m.timeZone} ${label}</div>
            </td>
        `;

        for (let i = 0; i < EVENT_OPTION_COUNT; i++) {
          const opt = eventOptions[i];
          let cellContent = "Pick a date/time";

          if (opt.utcDate) {
            cellContent = dualFormat(opt.utcDate, m.timeZone);
          }

          row += `<td>${cellContent}</td>`;
        }

        row += `</tr>`;
        eventBody.innerHTML += row;
      });
    }

    // ===== Setup Flatpickr for each event option (UTC inputs) =====
    function setupEventInputs() {
      for (let i = 0; i < EVENT_OPTION_COUNT; i++) {
        const timeInput = document.getElementById(`eventTime${i + 1}`);

        flatpickr(timeInput, {
          enableTime: true,
          time_24hr: true,
          dateFormat: "Y-m-d H:i",
          onChange: (selectedDates) => {
            const localDate = selectedDates[0] || null;
            eventOptions[i].utcDate = localSelectionToUTC(localDate);
            renderEventBoard();
          }
        });
      }
    }

    // ===== Initial render =====
    setupEventInputs();
    renderCurrent();
    renderEventBoard();

    // Live auto-update for current time table (every second)
    setInterval(renderCurrent, 1000);
  </script>
</body>
</html>
